#!/bin/bash
#
# .bashrc_zen
#
# Local work related changes
#

# Override Author
export GIT_AUTHOR_EMAIL="alex.bennee@linaro.org"

MY_USER=`id -u`
MY_GRP=`id -g`
USERSPEC="--userspec ${MY_USER}:${MY_GRP}"

# General paramters
QEMU_SRC=/home/alex/lsrc/qemu/qemu.git
QEMU_ARCH=aarch64
QEMU_BUILD=${QEMU_SRC}/${QEMU_ARCH}-linux-user
QEMU_BIN=qemu-${QEMU_ARCH}
QEMU_LOGFILE=/tmp/qemu.log

# Root of all rootfs
ROOT_ROOTFS=/home/alex/lsrc/qemu/rootfs

QEMU_ARGS="-d unimp"
# unimp,int,exec,cpu,op,out_asm
QEMU_PROFILE=""

: ${CURRENT_ROOTFS:=opensuse-arm64-rootfs}


function run_static_qemu
{
    date > ${QEMU_LOGFILE}

    ROOTFS=${ROOT_ROOTFS}/${CURRENT_ROOTFS}
    echo "Copying ${QEMU_BUILD}/${QEMU_BIN} to ${ROOTFS}/bin/" | tee -a ${QEMU_LOGFILE}
    sudo cp ${QEMU_BUILD}/${QEMU_BIN} ${ROOTFS}/bin/
    CMD="/bin/${QEMU_BIN} -D ${QEMU_LOGFILE} ${QEMU_ARGS}"
    echo "Using chroot: ${ROOTFS}" | tee -a ${QEMU_LOGFILE}
    echo "Running: ${CMD} with $# args ($@)" | tee -a ${QEMU_LOGFILE}
    sudo ${QEMU_PROFILE} chroot ${USERSPEC} ${ROOTFS} ${CMD} "$@"
}

function run_static_qemu_as_root
{
    date > ${QEMU_LOGFILE}

    ROOTFS=${ROOT_ROOTFS}/${CURRENT_ROOTFS}
    echo "Copying ${QEMU_BUILD}/${QEMU_BIN} to ${ROOTFS}/bin/" | tee -a ${QEMU_LOGFILE}
    sudo cp ${QEMU_BUILD}/${QEMU_BIN} ${ROOTFS}/bin/
    CMD="/bin/${QEMU_BIN} -D ${QEMU_LOGFILE} ${QEMU_ARGS}"
    echo "Using chroot: ${ROOTFS}" | tee -a ${QEMU_LOGFILE}
    echo "Running: ${CMD} with $# args ($@)" | tee -a ${QEMU_LOGFILE}
    ${QEMU_PROFILE} sudo chroot ${ROOTFS} ${CMD} "$@"
}


function set_dynamic_qemu_args
{
    export QEMU_LD_PREFIX=${ROOT_ROOTFS}/${CURRENT_ROOTFS}
    echo "Using QEMU_LD_PREFIX=${QEMU_LD_PREFIX}"
}

function set_qemu_profile
{
    OLD_QEMU_PROFILE=${QEMU_PROFILE}
    QEMU_PROFILE="$@"
    echo "Using QEMU_PROFILE=${QEMU_PROFILE} (was ${OLD_QEMU_PROFILE})"
}

function set_qemu_args
{
    OLD_QEMU_ARGS=${QEMU_ARGS}
    QEMU_ARGS=$@
    echo "Set args to ${QEMU_ARGS} (were ${OLD_QEMU_ARGS})"
}

function set_qemu_rootfs
{
    OLD_QEMU_ROOTFS=${CURRENT_ROOTFS}
    CURRENT_PWD=`pwd`
    cd ${ROOT_ROOTFS}
    DIRS=`compgen -d`
    read -e -p "dir:" CURRENT_ROOTFS
    echo "Set rootfs to ${CURRENT_ROOTFS} (was ${OLD_QEMU_ROOTFS})"
    cd -
}


alias .zen=". ~/.bash_zen"
